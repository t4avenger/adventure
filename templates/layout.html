{{define "layout.html"}}
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>adventure</title>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <link rel="stylesheet" href="/static/app.css" />
  <script>
    // Global function to update sidebar stats
    function updateSidebarStats() {
      // Look for stats-update in the swapped content first, then globally
      const statsEl = document.querySelector('#game .stats-update') || document.querySelector('.stats-update');
      if (statsEl) {
        const strength = statsEl.getAttribute('data-strength');
        const luck = statsEl.getAttribute('data-luck');
        const health = statsEl.getAttribute('data-health');
        const sidebarStrength = document.querySelector('#stat-strength');
        const sidebarLuck = document.querySelector('#stat-luck');
        const sidebarHealth = document.querySelector('#stat-health');
        if (sidebarStrength && strength !== null) sidebarStrength.textContent = strength;
        if (sidebarLuck && luck !== null) sidebarLuck.textContent = luck;
        if (sidebarHealth && health !== null) sidebarHealth.textContent = health;
      }
    }
    
    // Global function to update enemy sidebar
    function updateEnemySidebar() {
      const enemyEl = document.querySelector('#game .enemy-update') || document.querySelector('.enemy-update');
      const enemySidebar = document.querySelector('.enemy-sidebar');
      
      if (!enemySidebar) return;
      
      // Always hide by default
      enemySidebar.style.display = 'none';
      
      if (enemyEl) {
        const enemyName = enemyEl.getAttribute('data-enemy-name') || '';
        const enemyStrength = enemyEl.getAttribute('data-enemy-strength') || '0';
        const enemyHealth = enemyEl.getAttribute('data-enemy-health') || '0';
        
        // Parse health - handle both string and number
        const health = parseInt(enemyHealth, 10);
        const name = (enemyName || '').trim();
        
        // Only show enemy sidebar if enemy health > 0 and enemy name exists and is not empty
        if (!isNaN(health) && health > 0 && name !== '') {
          enemySidebar.classList.add('show');
          enemySidebar.style.display = 'flex';
          
          const nameEl = enemySidebar.querySelector('.enemy-stats div:first-child strong');
          const strengthEl = enemySidebar.querySelector('.enemy-stats div:nth-child(2) strong');
          const healthEl = enemySidebar.querySelector('.enemy-stats div:nth-child(3) strong');
          
          if (nameEl) nameEl.textContent = name;
          if (strengthEl) {
            const str = parseInt(enemyStrength, 10) || 0;
            strengthEl.textContent = str.toString();
          }
          if (healthEl) {
            healthEl.textContent = health.toString();
          }
        } else {
          enemySidebar.classList.remove('show');
        }
      }
    }
    
    // Set up event listeners
    function initStatsUpdater() {
      updateSidebarStats();
      updateEnemySidebar();
      // Update after HTMX swaps
      document.body.addEventListener('htmx:afterSwap', function(evt) {
        // Small delay to ensure DOM is updated
        setTimeout(function() {
          updateSidebarStats();
          updateEnemySidebar();
        }, 10);
      });
    }
    
    // Update on initial load (works whether DOM is ready or not)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initStatsUpdater);
    } else {
      initStatsUpdater();
    }
    
    // Also update after a short delay to catch any late-loading content
    setTimeout(function() {
      updateSidebarStats();
      updateEnemySidebar();
    }, 100);
  </script>
</head>
<body>
  <main class="wrap">
    <div class="container">
      <aside class="sidebar">
        <div class="character-image">
          <div class="character-placeholder">Character</div>
        </div>
        <div class="character-stats">
          <div>Strength: <strong id="stat-strength">{{if .State}}{{.State.Stats.Strength}}{{else if .Start}}{{.Start.Stats.Strength}}{{end}}</strong></div>
          <div>Luck: <strong id="stat-luck">{{if .State}}{{.State.Stats.Luck}}{{else if .Start}}{{.Start.Stats.Luck}}{{end}}</strong></div>
          <div>Health: <strong id="stat-health">{{if .State}}{{.State.Stats.Health}}{{else if .Start}}{{.Start.Stats.Health}}{{end}}</strong></div>
        </div>
      </aside>

      <section id="game" class="main-content">
        {{if .Start}}
            {{template "start.html" .Start}}
        {{else}}
            {{template "game.html" .}}
        {{end}}
      </section>

      <aside class="enemy-sidebar" style="display: none;">
        <div class="enemy-image">
          <div class="enemy-placeholder">Enemy</div>
        </div>
        <div class="enemy-stats">
          <div>Name: <strong></strong></div>
          <div>Strength: <strong></strong></div>
          <div>Health: <strong></strong></div>
        </div>
      </aside>
    </div>
  </main>
</body>
</html>
{{end}}
